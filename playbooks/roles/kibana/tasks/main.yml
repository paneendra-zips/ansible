---
# Install Kibana 

- name: Begin the setup of the Pre-reqs
  include_tasks: kb_prereqs.yml

- name: Install Kibana
  package:
    name: "{{ kibana_package }}"
    state: present

- name: Ensure Kibana service is started and enabled at boot
  service:
    name: kibana
    state: started
    enabled: true

- name: Check if Kibana Config File Path is in /opt/kibana/config
  stat:
    path: /opt/kibana/config/kibana.yml 
  register: opt_file_path
  ignore_errors: true

- name: Set /opt file path
  set_fact: kibana_config_file_path = "/opt/kibana/config/kibana.yml"  
  when: opt_file_path.stat.exists == True

- name: Check if Kibana Config File Path is in /etc/kibana
  stat:
    path: /etc/kibana/kibana.yml
  register: etc_file_path
  ignore_errors: true

- name: Set /etc file path
  set_fact: kibana_config_file_path = "/etc/kibana/kibana.yml"
  when: etc_file_path.stat.exists == True and opt_file_path.stat.exists == False


- name: Check if Kibana Config File Path is in /etc/default
  stat:
    path: /etc/default/kibana.yml
  register: etc_dt_file_path
  ignore_errors: true

- name: Set /etc file path
  set_fact: kibana_config_file_path = "/etc/default/kibana.yml"
  when: etc_dt_file_path.stat.exists == True and opt_file_path.stat.exists == False and etc_file_path.stat.exists == False


- fail:
    msg: "ERROR: Kibana config file - kibana.yml path does not exist in /etc or /opt. Configuration updates not completed"
  when: etc_file_path.stat.exists == False and opt_file_path.stat.exists == False and etc_dt_file_path.stat.exists == False 

- name: Copy Kibana configuration from template
  template:
    src: "{{ kibana_config_template }}"
    dest: "{{ kibana_config_file_path }}"
    owner: root
    group: root
    mode: 0644

...
